(()=>{"use strict";var e={811:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&r(t,e,n);return o(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(469);const u=a(n(252)),s=a(n(96)),d=a(n(577)),c=i(n(140)),l=a(n(221)),f=a(n(674)),h=a(n(648)),_=a(n(788)),p=a(n(968)),v=(0,u.default)();v.use((0,s.default)("dev")),v.use((0,d.default)({origin:[l.default.CLIENT_URL],exposedHeaders:["x-access-token"]})),v.use(u.default.json()),v.use(u.default.urlencoded({extended:!0})),v.get("/",((e,t)=>t.status(200).send('\n<div style="display: flex; align-items: center; justify-content: center; height: 90vh"> \n<h1 style="font-size: 72px; background: -webkit-linear-gradient(45deg, #09009f, #00ff95 80%); -webkit-background-clip: text;\n-webkit-text-fill-color: transparent;">BOOKSTORE REST API</h1>\n</div>\n'))),v.use("/cart",f.default),v.use("/book",h.default),v.use("/user",_.default),v.use("/payment",p.default),v.use(((e,t,n)=>n((0,c.default)(404,"Endpoint not found")))),v.use(((e,t,n,r)=>{console.error(e);let o="An unknown error occurred",i=500;(0,c.isHttpError)(e)&&(i=e.status,o=e.message),n.status(i).json({message:o,statusCode:i})})),t.default=v},405:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(740),a=o(n(232)),u=n(139),s=o(n(140));function d(e,t){if("all"===t)return e;for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e.slice(0,6)}t.default=(0,i.Controller)({getBooksByCategory(e,t){return r(this,void 0,void 0,(function*(){const{group:n,category:r,take:o}=e.query;let i;switch(n){case"bestselling":i=yield a.default.book.findMany(Object.assign({where:{bestSelling:!0}},u.OMIT_OPTIONS)),i=d(i,o);break;case"featured":i=yield a.default.book.findMany(Object.assign({where:{bestSelling:!1}},u.OMIT_OPTIONS)),i=d(i,o);break;default:i=yield a.default.book.findMany(Object.assign(Object.assign({},u.OMIT_OPTIONS),{where:{category:r}})),i=d(i,o)}return t.status(200).json(i)}))},getAllBooks(e,t){return r(this,void 0,void 0,(function*(){const e=yield a.default.book.findMany({select:{id:!0,title:!0,authors:!0,category:!0}});t.status(200).json(e)}))},getBook(e,t){return r(this,void 0,void 0,(function*(){const n=yield a.default.book.findUnique({where:{id:e.params.id}});if(!n)throw(0,s.default)(404,"Book not found");return t.status(200).json(n)}))}})},648:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(252),i=r(n(405)),a=(0,o.Router)();a.get("/",i.default.getAllBooks),a.get("/category",i.default.getBooksByCategory),a.get("/:id",i.default.getBook),t.default=a},571:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(232)),a=n(740),u=n(139),s=o(n(140)),d=e=>i.default.cart.findFirst(Object.assign(Object.assign({where:{userId:e,purchased:!1}},u.OMIT_OPTIONS),{include:{cartItems:Object.assign(Object.assign({},u.OMIT_OPTIONS),{include:{book:{select:{id:!0,title:!0,authors:!0,price:!0,thumbnail:{select:{small:!0}}}}}})}}));t.default=(0,a.Controller)({getCartItems(e,t){return r(this,void 0,void 0,(function*(){const n=yield d(e.user.id);return t.status(200).json(n?n.cartItems:[])}))},addToCart(e,t){return r(this,void 0,void 0,(function*(){const{bookId:n}=e.body,r=yield d(e.user.id);let o;if(r){if(r.cartItems.find((e=>e.book.id===n)))throw(0,s.default)(403,"Item already in cart")}else o=yield i.default.cart.create({data:{userId:e.user.id}});return yield i.default.cartItem.create({data:{cartId:r?r.id:o.id,bookId:n,quantity:1}}),t.status(201).json({message:"Item added to cart"})}))},changeCartQuantity(e,t){return r(this,void 0,void 0,(function*(){yield i.default.cartItem.update({where:{id:e.params.id},data:{quantity:e.body.quantity}}),t.status(200).json({message:"Cart item updated"})}))},deleteFromCart(e,t){return r(this,void 0,void 0,(function*(){yield i.default.cartItem.delete({where:{id:e.params.id}}),t.status(200).json({message:"Cart item deleted"})}))}})},674:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(252),i=r(n(571)),a=n(177),u=(0,o.Router)();u.get("/",a.userMiddleware,i.default.getCartItems),u.post("/",a.userMiddleware,i.default.addToCart),u.patch("/:id",a.userMiddleware,i.default.changeCartQuantity),u.delete("/:id",a.userMiddleware,i.default.deleteFromCart),t.default=u},156:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(811)),a=o(n(221)),u=o(n(232)),s=a.default.PORT;!function(){r(this,void 0,void 0,(function*(){try{yield u.default.$connect(),console.log("Connected to database"),i.default.listen(s,(()=>console.log("Listening on PORT "+s)))}catch(e){console.log(e)}}))}()},589:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=n(740),a=o(n(232));t.default=(0,i.Controller)({processPayment(e,t){return r(this,void 0,void 0,(function*(){return yield a.default.cart.update({where:{id:e.body.data.metadata.cartId},data:{purchased:!0}}),t.status(201).json({message:"Payment processed"})}))}})},968:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(252),i=r(n(589)),a=(0,o.Router)();a.post("/webhook",i.default.processPayment),t.default=a},209:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(740);t.default=(0,o.Controller)({getUser(e,t){return r(this,void 0,void 0,(function*(){return t.status(200).json(e.user)}))}})},177:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.userMiddleware=void 0;const i=o(n(232)),a=o(n(221)),u=n(740),s=o(n(829)),d=n(982);function c(){return r(this,void 0,void 0,(function*(){const e=function(){const e=["080","081","090","070","091"],t=(0,d.randomInt)(1e7,99999999).toString();return e[Math.floor(Math.random()*(e.length+1))]+t}(),t=`bookstore-${(0,d.randomUUID)().slice(0,5)}@bookstore.com`;return yield i.default.user.create({data:{email:t,phoneNumber:e},omit:{createdAt:!0,updatedAt:!0}})}))}t.userMiddleware=(0,u.asyncWrapper)(((e,t,n)=>r(void 0,void 0,void 0,(function*(){const{authorization:r}=e.headers;if(!r||!r.split(" ")[1]){const r=yield c(),o=function(e){return s.default.sign({user:e},a.default.JWT_SECRET,{expiresIn:"30 days"})}(r);return e.user=r,t.set("x-access-token",o),void n()}const o=r.split(" ")[1],i=s.default.verify(o,a.default.JWT_SECRET);e.user=i.user,n()}))))},788:function(e,t,n){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(252),i=n(177),a=r(n(209)),u=(0,o.Router)();u.get("/",i.userMiddleware,a.default.getUser),t.default=u},139:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OMIT_OPTIONS=void 0,t.OMIT_OPTIONS={omit:{createdAt:!1,updatedAt:!1}}},221:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(991);t.default=(0,r.cleanEnv)(process.env,{PORT:(0,r.num)({default:4001}),DATABASE_URL:(0,r.str)(),JWT_SECRET:(0,r.str)(),CLIENT_URL:(0,r.str)()})},232:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(330);let o;global.__prisma||(global.__prisma=new r.PrismaClient),o=global.__prisma,t.default=o},740:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,u)}s((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=t.asyncWrapper=void 0;t.asyncWrapper=e=>(t,r,o)=>n(void 0,void 0,void 0,(function*(){try{yield e(t,r,o)}catch(e){o(e)}}));t.Controller=e=>{for(let n of Object.keys(e))e[n]=(0,t.asyncWrapper)(e[n]);return e}},330:e=>{e.exports=require("@prisma/client")},577:e=>{e.exports=require("cors")},469:e=>{e.exports=require("dotenv/config")},991:e=>{e.exports=require("envalid")},252:e=>{e.exports=require("express")},140:e=>{e.exports=require("http-errors")},829:e=>{e.exports=require("jsonwebtoken")},96:e=>{e.exports=require("morgan")},982:e=>{e.exports=require("crypto")}},t={};(function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports})(156)})();
//# sourceMappingURL=index.js.map